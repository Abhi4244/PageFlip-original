var StPageFlip=function(t){var e={};function i(s){if(e[s])return e[s].exports;var h=e[s]={i:s,l:!1,exports:{}};return t[s].call(h.exports,h,h.exports,i),h.l=!0,h.exports}return i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var h in t)i.d(s,h,function(e){return t[e]}.bind(null,h));return s},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=0)}([function(t,e,i){"use strict";i.r(e),i.d(e,"App",(function(){return y}));class s{constructor(t){this.state={angle:0,area:[],corners:null,position:{x:0,y:0}},this.render=t}setPosition(t){this.state.position=t}setAngle(t){this.state.angle=t}setArea(t){this.state.area=t}setCorners(t){this.state.corners=t}getAngle(){return this.state.angle}}class h extends s{constructor(t,e){super(t),this.image=null,this.isLoad=!1,this.loadingAngle=0,this.href=e}draw(){const t=this.render.getContext(),e=this.render.convertToGlobal(this.state.position),i=this.render.getRect().pageWidth,s=this.render.getRect().height;t.save(),t.translate(e.x,e.y),t.beginPath();for(let i of this.state.area)null!==i&&(i=this.render.convertToGlobal(i),t.lineTo(i.x-e.x,i.y-e.y));if(t.rotate(this.state.angle),t.clip(),this.isLoad)t.drawImage(this.image,0,0,i,s);else{t.beginPath(),t.strokeStyle="rgb(200, 200, 200)",t.fillStyle="rgb(255, 255, 255)",t.lineWidth=1,t.rect(1,1,i-1,s-1),t.stroke(),t.fill();const e={x:i/2,y:s/2};t.beginPath(),t.lineWidth=10,t.arc(e.x,e.y,20,this.loadingAngle,3*Math.PI/2+this.loadingAngle),t.stroke(),t.closePath(),this.loadingAngle+=.07,this.loadingAngle>=2*Math.PI&&(this.loadingAngle=0)}t.restore()}simpleDraw(t){const e=this.render.getRect(),i=this.render.getContext(),s=e.pageWidth,h=e.height,n=1===t?e.left+e.pageWidth:e.left,o=e.top;if(this.isLoad)i.drawImage(this.image,n,o,s,h);else{i.beginPath(),i.strokeStyle="rgb(200, 200, 200)",i.fillStyle="rgb(255, 255, 255)",i.lineWidth=1,i.rect(n+1,o+1,s-1,h-1),i.stroke(),i.fill();const t={x:n+s/2,y:o+h/2};i.beginPath(),i.lineWidth=10,i.arc(t.x,t.y,20,this.loadingAngle,3*Math.PI/2+this.loadingAngle),i.stroke(),i.closePath(),this.loadingAngle+=.07,this.loadingAngle>=2*Math.PI&&(this.loadingAngle=0)}}async load(){return null==this.image&&(this.image=new Image,this.image.src=this.href),this.isLoad?Promise.resolve(this):new Promise(t=>{this.image.onload=()=>{this.isLoad=!0,t(this)}})}}class n{constructor(t){this.pages=[],this.render=t}getPageCount(){return this.pages.length}getPages(){return this.pages}getPage(t){if(t>=0&&t<this.pages.length)return this.pages[t];throw new Error("Invalid page number")}show(t){t<0||t>=this.pages.length||(0===this.render.getOrientation()?(this.render.setLeftPage(null),this.render.setRightPage(this.pages[t])):(t===this.pages.length-1&&t--,this.render.setLeftPage(this.pages[t]),this.render.setRightPage(this.pages[t+1])))}}class o extends n{constructor(t,e){super(t),this.imagesHref=e}async load(){const t=[];for(const e of this.imagesHref){const i=new h(this.render,e);t.push(i.load()),this.pages.push(i)}return Promise.all(t)}}class r{static GetDestinationFromTwoPoint(t,e){return null===t||null===e?1/0:Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))}static GetSegmentLength(t){return r.GetDestinationFromTwoPoint(t[0],t[1])}static GetAngleFromTwoLine(t,e){const i=t[0].y-t[1].y,s=e[0].y-e[1].y,h=t[1].x-t[0].x,n=e[1].x-e[0].x;return Math.acos((i*s+h*n)/(Math.sqrt(i*i+h*h)*Math.sqrt(s*s+n*n)))}static PointInRect(t,e){return null===e?null:e.x>=t.left&&e.x<=t.width+t.left&&e.y>=t.top&&e.y<=t.top+t.height?e:null}static GetRotatedPoint(t,e,i){return{x:t.x*Math.cos(i)+t.y*Math.sin(i)+e.x,y:t.y*Math.cos(i)-t.x*Math.sin(i)+e.y}}static GetIntersectByLineAndCircle(t,e,i){if(r.GetDestinationFromTwoPoint(t,i)<=e)return i;const s=t.x,h=t.y,n=i.x,o=i.y;let a=Math.sqrt(Math.pow(e,2)*Math.pow(s-n,2)/(Math.pow(s-n,2)+Math.pow(h-o,2)))+s;i.x<0&&(a*=-1);let g=(a-s)*(h-o)/(s-n)+h;return s-n+h===0&&(g=e),{x:a,y:g}}static GetIntersectByTwoSegment(t,e,i){return r.PointInRect(t,r.GetIntersectByTwoLine(e,i))}static GetIntersectByTwoLine(t,e){const i=t[0].y-t[1].y,s=e[0].y-e[1].y,h=t[1].x-t[0].x,n=e[1].x-e[0].x,o=t[0].x*t[1].y-t[1].x*t[0].y,r=e[0].x*e[1].y-e[1].x*e[0].y,a=i*r-s*o,g=h*r-n*o,l=-(o*n-r*h)/(i*n-s*h),c=-(i*r-s*o)/(i*n-s*h);if(isFinite(l)&&isFinite(c))return{x:l,y:c};if(Math.abs(a-g)<.1)throw new Error("Segment included");return null}static GetCordsFromTwoPoint(t,e){const i=Math.abs(t.x-e.x),s=Math.abs(t.y-e.y),h=Math.max(i,s),n=[t];function o(t,e,i,s,h){return e>t?t+h*(i/s):e<t?t-h*(i/s):t}for(let r=1;r<=h;r++)n.push({x:o(t.x,e.x,i,h,r),y:o(t.y,e.y,s,h,r)});return n}}class a extends s{constructor(t,e){super(t),this.copiedElement=null,this.isLoad=!1,this.element=e}draw(){const t=this.render.convertToGlobal(this.state.position),e=this.render.getRect().pageWidth,i=this.render.getRect().height;this.copiedElement=null,this.element.classList.remove("--simple"),this.element.style.display="block",this.element.style.transformOrigin="0 0",this.element.style.left="0",this.element.style.top="0",this.element.style.width=e+"px",this.element.style.height=i+"px";let s="polygon( ";for(const t of this.state.area)if(null!==t){let e=1===this.render.getDirection()?{x:-t.x+this.state.position.x,y:t.y-this.state.position.y}:{x:t.x-this.state.position.x,y:t.y-this.state.position.y};e=r.GetRotatedPoint(e,{x:0,y:0},this.state.angle),s+=e.x+"px "+e.y+"px, "}s=s.slice(0,-2),s+=")",this.element.style.clipPath=s,this.element.style.setProperty("-webkit-clip-path",s),this.element.style.transform="translate("+t.x+"px, "+t.y+"px) rotate("+this.state.angle+"rad)"}simpleDraw(t){if(this.element.classList.contains("--simple"))return;null===this.copiedElement&&(this.copiedElement=this.element.cloneNode(!0),this.element.parentElement.appendChild(this.copiedElement));const e=this.render.getRect(),i=e.pageWidth,s=e.height,h=1===t?e.left+e.pageWidth:e.left,n=e.top;this.element.classList.add("--simple"),this.copiedElement.style.cssText="position: absolute; display: block; height: "+s+"px; left: "+h+"px; top: "+n+"px; width: "+i+"px; z-index: 2",this.element.style.cssText="display: none"}getElement(){return this.element}async load(){return this.isLoad=!0,this}}class g extends n{constructor(t,e){super(t),this.element=e,this.pagesElement=e.querySelectorAll(".stf__item")}async load(){const t=[];for(const e of this.pagesElement){const i=new a(this.render,e);t.push(i.load()),this.pages.push(i)}return Promise.all(t)}}class l{constructor(t,e,i,s){this.direction=t,this.corner=e,this.pageWidth=i,this.pageHeight=s,this.topIntersectPoint=null,this.sideIntersectPoint=null,this.bottomIntersectPoint=null}calc(t){try{this.position=this.preparePosition(t),this.calculateIntersectPoint(this.position)}catch(t){console.log(t)}}getPageRect(t){return 0===this.corner?this.getRectFromBasePoint([{x:0,y:0},{x:this.pageWidth,y:0},{x:0,y:this.pageHeight},{x:this.pageWidth,y:this.pageHeight}],t):this.getRectFromBasePoint([{x:0,y:-this.pageHeight},{x:this.pageWidth,y:-this.pageHeight},{x:0,y:0},{x:this.pageWidth,y:0}],t)}getRectFromBasePoint(t,e){return{topLeft:this.getRotatedPoint(t[0],e),topRight:this.getRotatedPoint(t[1],e),bottomLeft:this.getRotatedPoint(t[2],e),bottomRight:this.getRotatedPoint(t[3],e)}}getRotatedPoint(t,e,i=null){return null===i&&(i=this.angle),{x:t.x*Math.cos(this.angle)+t.y*Math.sin(this.angle)+e.x,y:t.y*Math.cos(this.angle)-t.x*Math.sin(this.angle)+e.y}}updateAngleAndGeometry(t){this.angle=this.calculateAngle(t),this.rect=this.getPageRect(t)}calculateIntersectPoint(t){const e={left:-1,top:-1,width:this.pageWidth+2,height:this.pageHeight+2};0===this.corner?(this.topIntersectPoint=r.GetIntersectByTwoSegment(e,[t,this.rect.topRight],[{x:0,y:0},{x:this.pageWidth,y:0}]),this.sideIntersectPoint=r.GetIntersectByTwoSegment(e,[t,this.rect.bottomLeft],[{x:this.pageWidth,y:0},{x:this.pageWidth,y:this.pageHeight}]),this.bottomIntersectPoint=r.GetIntersectByTwoSegment(e,[this.rect.bottomLeft,this.rect.bottomRight],[{x:0,y:this.pageHeight},{x:this.pageWidth,y:this.pageHeight}])):(this.topIntersectPoint=r.GetIntersectByTwoSegment(e,[this.rect.topLeft,this.rect.topRight],[{x:0,y:0},{x:this.pageWidth,y:0}]),this.sideIntersectPoint=r.GetIntersectByTwoSegment(e,[t,this.rect.topLeft],[{x:this.pageWidth,y:0},{x:this.pageWidth,y:this.pageHeight}]),this.bottomIntersectPoint=r.GetIntersectByTwoSegment(e,[this.rect.bottomLeft,this.rect.bottomRight],[{x:0,y:this.pageHeight},{x:this.pageWidth,y:this.pageHeight}]))}checkPositionAtCenterLine(t,e,i){let s=t;const h=r.GetIntersectByLineAndCircle(e,this.pageWidth,s);s!==h&&(s=h,this.updateAngleAndGeometry(s));const n=Math.sqrt(Math.pow(this.pageWidth,2)+Math.pow(this.pageHeight,2));let o=this.rect.bottomRight,a=this.rect.topLeft;if(1===this.corner&&(o=this.rect.topRight,a=this.rect.bottomLeft),o.x<=0){const t=r.GetIntersectByLineAndCircle(i,n,a);t!==s&&(s=t,this.updateAngleAndGeometry(s))}return s}preparePosition(t){let e=t;if(this.updateAngleAndGeometry(e),e=0===this.corner?this.checkPositionAtCenterLine(e,{x:0,y:0},{x:0,y:this.pageHeight}):this.checkPositionAtCenterLine(e,{x:0,y:this.pageHeight},{x:0,y:0}),Math.abs(e.x-this.pageWidth)<1&&Math.abs(e.y)<1)throw new Error("Point is too small");return e}calculateAngle(t){const e=this.pageWidth-t.x,i=1===this.corner?this.pageHeight-t.y:t.y;let s=2*Math.acos(e/Math.sqrt(i*i+e*e));i<0&&(s=-s);const h=Math.PI-s;if(!isFinite(s)||h>=0&&h<.003)throw new Error("The G point is too small");return 1===this.corner&&(s=-s),s}getAngle(){return 0===this.direction?-this.angle:this.angle}getRect(){return this.rect}getPosition(){return this.position}getActiveCorner(){return 0===this.direction?this.rect.topLeft:this.rect.topRight}getDirection(){return this.direction}getIntersectPoint(){return{top:this.topIntersectPoint,bottom:this.bottomIntersectPoint,side:this.sideIntersectPoint}}getSegmentToShadowLine(){const t=this.getShadowStartPoint();return[t,t!==this.sideIntersectPoint&&null!==this.sideIntersectPoint?this.sideIntersectPoint:this.bottomIntersectPoint]}getShadowStartPoint(){return 0===this.corner?this.topIntersectPoint:null!==this.sideIntersectPoint?this.sideIntersectPoint:this.topIntersectPoint}getShadowAngle(){const t=r.GetAngleFromTwoLine(this.getSegmentToShadowLine(),[{x:0,y:0},{x:this.pageWidth,y:0}]);return 0===this.direction?t:Math.PI-t}getShadowLength(){return r.GetSegmentLength(this.getSegmentToShadowLine())}getFlippingProgress(){return Math.abs((this.position.x-this.pageWidth)/(2*this.pageWidth)*100)}getFlippingClipArea(){const t=[];let e=!1;return t.push(this.rect.topLeft),t.push(this.topIntersectPoint),null===this.sideIntersectPoint?e=!0:(t.push(this.sideIntersectPoint),null===this.bottomIntersectPoint&&(e=!1)),t.push(this.bottomIntersectPoint),(e||1===this.corner)&&t.push(this.rect.bottomLeft),t}getCorner(){return this.corner}getBottomClipArea(){const t=[];return t.push(this.topIntersectPoint),0===this.corner?t.push({x:this.pageWidth,y:0}):(null!==this.topIntersectPoint&&t.push({x:this.pageWidth,y:0}),t.push({x:this.pageWidth,y:this.pageHeight})),null!==this.sideIntersectPoint?r.GetDestinationFromTwoPoint(this.sideIntersectPoint,this.topIntersectPoint)>=10&&t.push(this.sideIntersectPoint):0===this.corner&&t.push({x:this.pageWidth,y:this.pageHeight}),t.push(this.bottomIntersectPoint),t.push(this.topIntersectPoint),t}getBottomPagePosition(){return 1===this.direction?{x:this.pageWidth,y:0}:{x:0,y:0}}}class c{constructor(t,e){this.flippingPage=null,this.bottomPage=null,this.calc=null,this.state="read",this.render=t,this.app=e}getCalculation(){return this.calc}start(t){this.reset();const e=this.render.convertToBook(t),i=this.getBoundsRect();let s=0;0===this.render.getOrientation()?e.x-i.pageWidth<=i.width/5&&(s=1):e.x<i.width/2&&(s=1);const h=e.y>=i.height/2?1:0;if(!this.checkDirection(s))return!1;try{return this.flippingPage=this.getFlippingPage(s),this.bottomPage=this.getBottomPage(s),this.flippingPage&&this.bottomPage?(this.render.setDirection(s),this.calc=new l(s,h,i.pageWidth,i.height),!0):!1}catch(t){return!1}}showCorner(t){if(!this.checkState("read","fold_corner"))return;const e=this.getBoundsRect(),i=e.pageWidth,s=Math.sqrt(Math.pow(i,2)+Math.pow(e.height,2))/5,h=this.render.convertToBook(t);if(h.x>0&&h.y>0&&h.x<e.width&&h.y<e.height&&(h.x<s||h.x>e.width-s)&&(h.y<s||h.y>e.height-s))if(null===this.calc){if(!this.start(t))return;this.setState("fold_corner"),this.calc.calc({x:i-1,y:1});const s=50,h=1===this.calc.getCorner()?e.height-1:1,n=1===this.calc.getCorner()?e.height-s:s;this.animateFlippingTo({x:i-1,y:h},{x:i-s,y:n},!1,!1)}else this.do(this.render.convertToPage(t));else this.setState("read"),this.render.finishAnimation(),this.stopMove()}fold(t){this.setState("user_fold"),null===this.calc&&this.start(t),this.do(this.render.convertToPage(t))}flip(t){if(null!==this.calc&&this.render.finishAnimation(),!this.start(t))return;const e=this.getBoundsRect();this.setState("flipping");const i=e.height/10,s=1===this.calc.getCorner()?e.height-i:i,h=1===this.calc.getCorner()?e.height:0;this.calc.calc({x:e.pageWidth-i,y:s}),this.animateFlippingTo({x:e.pageWidth-i,y:s},{x:-e.pageWidth,y:h},!0)}stopMove(){if(null===this.calc)return;const t=this.calc.getPosition(),e=this.getBoundsRect(),i=1===this.calc.getCorner()?e.height:0;t.x<=0?this.animateFlippingTo(t,{x:-e.pageWidth,y:i},!0):this.animateFlippingTo(t,{x:e.pageWidth,y:i},!1)}do(t){null!==this.calc&&(this.calc.calc(t),this.flippingPage.setArea(this.calc.getFlippingClipArea()),this.flippingPage.setPosition(this.calc.getActiveCorner()),this.flippingPage.setAngle(this.calc.getAngle()),this.bottomPage.setArea(this.calc.getBottomClipArea()),this.bottomPage.setPosition(this.calc.getBottomPagePosition()),this.bottomPage.setAngle(0),this.render.setPageRect(this.calc.getRect()),this.render.setBottomPage(this.bottomPage),this.render.setFlippingPage(this.flippingPage),this.render.drawShadow(this.calc.getShadowStartPoint(),this.calc.getShadowAngle(),this.calc.getFlippingProgress(),this.calc.getDirection(),this.calc.getShadowLength()))}animateFlippingTo(t,e,i,s=!0){const h=r.GetCordsFromTwoPoint(t,e),n=[];for(const t of h)n.push(()=>this.do(t));const o=this.getAnimationDuration(h.length);this.render.startAnimation(n,o,()=>{i&&(1===this.calc.getDirection()?this.app.turnToPrevPage():this.app.turnToNextPage()),s&&(this.render.setBottomPage(null),this.render.setFlippingPage(null),this.render.clearShadow(),this.state="read",this.reset())})}getAnimationDuration(t){return t<200?400:t<500?470:1e3}getFlippingPage(t){const e=this.app.getCurrentPageIndex();return 0===this.render.getOrientation()?0===t?this.app.getPage(e):this.app.getPage(e-1):e<this.app.getPageCount()-1&&e>=0?0===t?this.app.getPage(e+2):this.app.getPage(e-1):null}getNextPage(){const t=this.app.getCurrentPageIndex(),e=0===this.render.getOrientation()?0:2;return t<this.app.getPageCount()-e?this.app.getPage(t+e+1):null}getPrevPage(){const t=this.app.getCurrentPageIndex(),e=0===this.render.getOrientation()?0:2;return t-e>=0?this.app.getPage(t-e):null}getBottomPage(t){return 0===t?this.getNextPage():this.getPrevPage()}checkDirection(t){return 0===t?this.app.getCurrentPageIndex()<=this.app.getPageCount()-1:this.app.getCurrentPageIndex()>=1}reset(){this.calc=null,this.flippingPage=null,this.bottomPage=null}getBoundsRect(){return this.render.getRect()}getPageWidth(){return this.getBoundsRect().width/2}getPageHeight(){return this.getBoundsRect().height}setState(t){this.app.updateState(t),this.state=t}checkState(...t){for(const e of t)if(this.state===e)return!0;return!1}}class d{constructor(t){this.leftPage=null,this.rightPage=null,this.flippingPage=null,this.bottomPage=null,this.shadow=null,this.pageRect=null,this.animation=null,this.timer=0,this.direction=null,this.orientation=null,this.fps=0,this.startTimer=0,this._startTimer=0,this.setting=t}drawShadow(t,e,i,s,h){this.shadow={pos:t,angle:e,width:3*this.getRect().pageWidth/4*i/100,opacity:(100-i)/100,direction:s,length:h}}clearShadow(){this.shadow=null}setPageRect(t){this.pageRect=t}getOrientation(){return null===this.orientation&&(this.orientation=this.findOrientation()),this.orientation}startAnimation(t,e,i){this.finishAnimation(),this.animation={frames:t,duration:e,durationFrame:e/t.length,onAnimateEnd:i,startedAt:this.timer}}finishAnimation(){null!==this.animation&&(this.animation.frames[this.animation.frames.length-1](),null!==this.animation.onAnimateEnd&&this.animation.onAnimateEnd()),this.animation=null}render(t){if(null!==this.animation){const e=Math.round((t-this.animation.startedAt)/this.animation.durationFrame);e<this.animation.frames.length?this.animation.frames[e]():(this.animation.onAnimateEnd(),this.animation=null)}this.timer=t,this.drawFrame(t)}findOrientation(){return this.getBlockHeight()>this.getBlockWidth()?0:1}getRect(){const t=this.findOrientation(),e=this.getBlockWidth()/2,i=this.getBlockHeight()/2,s=this.setting.width/this.setting.height;let h=this.setting.width,n=this.setting.height,o=e-h;return 1===this.setting.size&&(h=1===t?this.getBlockWidth()/2:this.getBlockWidth(),h>this.setting.maxWidth&&(h=this.setting.maxWidth),n=h/s,n>this.getBlockHeight()&&(n=this.getBlockHeight(),h=n*s),o=1===t?e-h:e-h/2-h),this.orientation=t,{left:o,top:i-n/2,width:2*h,height:n,pageWidth:h}}convertToBook(t){const e=this.getRect();return{x:t.x-e.left,y:t.y-e.top}}convertToPage(t,e){e||(e=this.direction);const i=this.getRect();return{x:0===e?t.x-i.left-i.width/2:i.width/2-t.x+i.left,y:t.y-i.top}}convertToGlobal(t,e){if(e||(e=this.direction),null==t)return null;const i=this.getRect();return{x:0===e?t.x+i.left+i.width/2:i.width/2-t.x+i.left,y:t.y+i.top}}convertRectToGlobal(t,e){return e||(e=this.direction),{topLeft:this.convertToGlobal(t.topLeft,e),topRight:this.convertToGlobal(t.topRight,e),bottomLeft:this.convertToGlobal(t.bottomLeft,e),bottomRight:this.convertToGlobal(t.bottomRight,e)}}start(){this._startTimer=0;const t=e=>{0==this._startTimer&&(this._startTimer=e),e-this.startTimer>=1e3&&(this.startTimer=e),e-this._startTimer>1e3&&(document.getElementById("fps").innerHTML=this.fps.toString(10),this.fps=0,this._startTimer=e),this.render(e),requestAnimationFrame(t),this.fps++};requestAnimationFrame(t)}setDirection(t){this.direction=t}getDirection(){return this.direction}setFlippingPage(t){this.flippingPage=t}setBottomPage(t){this.bottomPage=t}setRightPage(t){this.rightPage=t}setLeftPage(t){this.leftPage=t}}class p extends d{constructor(t,e){super(e),this.canvas=t,this.ctx=t.getContext("2d")}getBlockWidth(){return this.canvas.width}getBlockHeight(){return this.canvas.height}getContext(){return this.ctx}drawFrame(t){this.clear(),0!==this.orientation&&null!=this.leftPage&&this.leftPage.simpleDraw(0),null!=this.rightPage&&this.rightPage.simpleDraw(1),null!=this.bottomPage&&this.bottomPage.draw(),this.drawBookShadow(),null!=this.flippingPage&&this.flippingPage.draw(),null!=this.shadow&&(this.drawOuterShadow(),this.drawInnerShadow());const e=this.getRect();0===this.orientation&&(this.ctx.beginPath(),this.ctx.rect(e.left+e.pageWidth,e.top,e.width,e.height),this.ctx.clip())}drawBookShadow(){const t=this.getRect();this.ctx.save(),this.ctx.beginPath();const e=t.width/20;this.ctx.rect(t.left,t.top,t.width,t.height);const i={x:t.left+t.width/2-e/2,y:0};this.ctx.translate(i.x,i.y);const s=this.ctx.createLinearGradient(0,0,e,0);s.addColorStop(0,"rgba(0, 0, 0, 0)"),s.addColorStop(.4,"rgba(0, 0, 0, 0.2)"),s.addColorStop(.49,"rgba(0, 0, 0, 0.1)"),s.addColorStop(.5,"rgba(0, 0, 0, 0.5)"),s.addColorStop(.51,"rgba(0, 0, 0, 0.4)"),s.addColorStop(1,"rgba(0, 0, 0, 0)"),this.ctx.clip(),this.ctx.fillStyle=s,this.ctx.fillRect(0,0,e,2*t.height),this.ctx.restore()}drawOuterShadow(){const t=this.getRect();this.ctx.save(),this.ctx.beginPath(),this.ctx.rect(t.left,t.top,t.width,t.height);const e=this.convertToGlobal({x:this.shadow.pos.x,y:this.shadow.pos.y});this.ctx.translate(e.x,e.y),this.ctx.rotate(Math.PI+this.shadow.angle+Math.PI/2);const i=this.ctx.createLinearGradient(0,0,this.shadow.width,0);0===this.shadow.direction?(this.ctx.translate(0,-100),i.addColorStop(0,"rgba(0, 0, 0, "+this.shadow.opacity+")"),i.addColorStop(1,"rgba(0, 0, 0, 0)")):(this.ctx.translate(-this.shadow.width,-100),i.addColorStop(0,"rgba(0, 0, 0, 0)"),i.addColorStop(1,"rgba(0, 0, 0, "+this.shadow.opacity+")")),this.ctx.clip(),this.ctx.fillStyle=i,this.ctx.fillRect(0,0,this.shadow.width,2*t.height),this.ctx.restore()}drawInnerShadow(){const t=this.getRect();this.ctx.save(),this.ctx.beginPath();const e=this.convertToGlobal({x:this.shadow.pos.x,y:this.shadow.pos.y}),i=this.convertRectToGlobal(this.pageRect);this.ctx.moveTo(i.topLeft.x,i.topLeft.y),this.ctx.lineTo(i.topRight.x,i.topRight.y),this.ctx.lineTo(i.bottomRight.x,i.bottomRight.y),this.ctx.lineTo(i.bottomLeft.x,i.bottomLeft.y),this.ctx.translate(e.x,e.y),this.ctx.rotate(Math.PI+this.shadow.angle+Math.PI/2);const s=3*this.shadow.width/4,h=this.ctx.createLinearGradient(0,0,s,0);0===this.shadow.direction?(this.ctx.translate(-s,-100),h.addColorStop(1,"rgba(0, 0, 0, "+this.shadow.opacity+")"),h.addColorStop(.9,"rgba(0, 0, 0, 0.05)"),h.addColorStop(.7,"rgba(0, 0, 0, "+this.shadow.opacity+")"),h.addColorStop(0,"rgba(0, 0, 0, 0)")):(this.ctx.translate(0,-100),h.addColorStop(0,"rgba(0, 0, 0, "+this.shadow.opacity+")"),h.addColorStop(.1,"rgba(0, 0, 0, 0.05)"),h.addColorStop(.3,"rgba(0, 0, 0, "+this.shadow.opacity+")"),h.addColorStop(1,"rgba(0, 0, 0, 0)")),this.ctx.clip(),this.ctx.fillStyle=h,this.ctx.fillRect(0,0,s,2*t.height),this.ctx.restore()}clear(){this.ctx.fillStyle="white",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}}class u{constructor(t,e,i){t.classList.add("stf__wrapper"),t.setAttribute("style","min-width: "+2*i.minWidth+"px; min-height: "+i.minHeight+"px"),0===i.size&&t.setAttribute("style","min-width: "+2*i.width+"px; min-height: "+i.height+"px"),this.app=e}setHandlers(){this.distElement.onmousedown=t=>{const e=this.getMousePos(t.clientX,t.clientY);return this.app.startUserTouch(e),!1},this.distElement.ontouchstart=t=>{if(t.changedTouches.length>0){const e=t.changedTouches[0];return this.app.startUserTouch(this.getMousePos(e.clientX,e.clientY)),!1}},window.onmousemove=t=>{const e=this.getMousePos(t.clientX,t.clientY);return this.app.userMove(e),!1},window.ontouchmove=t=>{if(t.changedTouches.length>0){const e=t.changedTouches[0];this.app.userMove(this.getMousePos(e.clientX,e.clientY))}},window.onmouseup=t=>{const e=this.getMousePos(t.clientX,t.clientY);return this.app.userStop(e),!1},window.ontouchend=t=>{if(t.changedTouches.length>0){const e=t.changedTouches[0];this.app.userStop(this.getMousePos(e.clientX,e.clientY))}}}getDistElement(){return this.distElement}getMousePos(t,e){const i=this.distElement.getBoundingClientRect();return{x:t-i.left,y:e-i.top}}}class P extends u{constructor(t,e,i){super(t,e,i),this.distElement=t.querySelector(".stf__block"),this.setHandlers()}}class m extends u{constructor(t,e,i){super(t,e,i),t.innerHTML="<canvas></canvas>",this.canvas=t.querySelectorAll("canvas")[0],window.addEventListener("resize",()=>{this.resizeCanvas()},!1),this.distElement=this.canvas,this.resizeCanvas(),this.setHandlers()}resizeCanvas(){const t=getComputedStyle(this.canvas),e=parseInt(t.getPropertyValue("width"),10),i=parseInt(t.getPropertyValue("height"),10);this.canvas.width=e,this.canvas.height=i}getCanvas(){return this.canvas}}class x extends d{constructor(t,e){super(e),this.outerShadow=null,this.innerShadow=null,this.element=t,this.items=t.querySelectorAll(".stf__item")}getBlockWidth(){return this.element.offsetWidth}getBlockHeight(){return this.element.offsetHeight}clearShadow(){super.clearShadow(),this.element.querySelector(".stf__outerShadow").remove(),this.element.querySelector(".stf__innerShadow").remove(),this.outerShadow=null,this.innerShadow=null}drawShadow(t,e,i,s,h){super.drawShadow(t,e,i,s,h),null===this.outerShadow&&(this.element.insertAdjacentHTML("beforeend",'<div class="stf__outerShadow"></div>'),this.outerShadow=this.element.querySelector(".stf__outerShadow")),null===this.innerShadow&&(this.element.insertAdjacentHTML("beforeend",'<div class="stf__innerShadow"></div>'),this.innerShadow=this.element.querySelector(".stf__innerShadow"))}drawInnerShadow(){const t=this.getRect(),e=3*this.shadow.width/4,i=0===this.getDirection()?e:0,s=0===this.getDirection()?"to left":"to right",h=this.convertToGlobal(this.shadow.pos),n=this.shadow.angle+3*Math.PI/2;this.innerShadow.style.left=h.x+"px",this.innerShadow.style.top=h.y+"px",this.innerShadow.style.width=e+"px",this.innerShadow.style.height=2*t.height+"px",this.innerShadow.style.background="linear-gradient("+s+", rgba(0, 0, 0, "+this.shadow.opacity+") 5%, rgba(0, 0, 0, 0.05) 15%,rgba(0, 0, 0, "+this.shadow.opacity+") 35%, rgba(0, 0, 0, 0) 100% )",this.innerShadow.style.transformOrigin=i+"px 100px",this.innerShadow.style.transform="translate("+-i+"px, -100px) rotate("+n+"rad)";const o=[this.pageRect.topLeft,this.pageRect.topRight,this.pageRect.bottomRight,this.pageRect.bottomLeft];let a="polygon( ";for(const t of o){let e=1===this.getDirection()?{x:-t.x+this.shadow.pos.x,y:t.y-this.shadow.pos.y}:{x:t.x-this.shadow.pos.x,y:t.y-this.shadow.pos.y};e=r.GetRotatedPoint(e,{x:i,y:100},n),a+=e.x+"px "+e.y+"px, "}a=a.slice(0,-2),a+=")",this.innerShadow.style.clipPath=a,this.innerShadow.style.setProperty("-webkit-clip-path",a)}drawOuterShadow(){const t=this.getRect(),e=this.convertToGlobal({x:this.shadow.pos.x,y:this.shadow.pos.y}),i=this.shadow.angle+3*Math.PI/2,s=1===this.getDirection()?this.shadow.width:0,h=0===this.getDirection()?"to right":"to left";this.outerShadow.style.left=e.x+"px",this.outerShadow.style.top=e.y+"px",this.outerShadow.style.width=this.shadow.width+"px",this.outerShadow.style.height=2*t.height+"px",this.outerShadow.style.background="linear-gradient("+h+", rgba(0, 0, 0, "+this.shadow.opacity+"), rgba(0, 0, 0, 0))",this.outerShadow.style.transformOrigin=s+"px 100px",this.outerShadow.style.transform="translate("+-s+"px, -100px) rotate("+i+"rad)";const n=[];n.push({x:0,y:0},{x:t.pageWidth,y:0},{x:t.pageWidth,y:t.height},{x:0,y:t.height});let o="polygon( ";for(const t of n)if(null!==t){let e=1===this.getDirection()?{x:-t.x+this.shadow.pos.x,y:t.y-this.shadow.pos.y}:{x:t.x-this.shadow.pos.x,y:t.y-this.shadow.pos.y};e=r.GetRotatedPoint(e,{x:s,y:100},i),o+=e.x+"px "+e.y+"px, "}o=o.slice(0,-2),o+=")",this.outerShadow.style.clipPath=o,this.outerShadow.style.setProperty("-webkit-clip-path",o)}drawFrame(t){this.clear(),0!==this.orientation&&null!=this.leftPage&&this.leftPage.simpleDraw(0),null!=this.rightPage&&this.rightPage.simpleDraw(1),null!=this.bottomPage&&(this.bottomPage.getElement().style.zIndex="3",this.bottomPage.draw()),null!=this.flippingPage&&(this.flippingPage.getElement().style.zIndex="4",this.flippingPage.draw()),this.shadow}clear(){const t=[];this.leftPage&&t.push(this.leftPage.getElement()),this.rightPage&&t.push(this.rightPage.getElement()),this.flippingPage&&t.push(this.flippingPage.getElement()),this.bottomPage&&t.push(this.bottomPage.getElement());for(const e of this.items)t.includes(e)||(e.style.display="none",e.style.zIndex="1",e.style.transform="")}setRightPage(t){super.setRightPage(t)}setLeftPage(t){super.setLeftPage(t)}setFlippingPage(t){super.setFlippingPage(t)}}class y extends class{constructor(){this.events={}}on(t,e){return t in this.events?this.events[t].push(e):this.events[t]=[e],this}off(t){delete this.events[t]}trigger(t,e,i=null){t in this.events&&this.events[t].forEach(t=>{t({data:i,object:e})})}}{constructor(t,e){super(),this.isUserTouch=!1,this.isUserMove=!1,this.pages=null,this.currentPage=0,this.setting={width:600,height:800,size:1,minWidth:150,maxWidth:900,minHeight:300,maxHeight:2200,startPage:2},this.block=t}update(){this.pages.show(this.currentPage)}turnToPrevPage(){const t=0===this.render.getOrientation()?1:2;this.currentPage<t||(this.currentPage-=t,this.pages.show(this.currentPage),this.trigger("flip",this,this.currentPage))}turnToNextPage(){const t=0===this.render.getOrientation()?1:2;this.currentPage>this.pages.getPageCount()-t||(this.currentPage+=t,this.pages.show(this.currentPage),this.trigger("flip",this,this.currentPage))}turnToPage(t){this.checkPage(t)&&(this.currentPage=t,this.pages.show(this.currentPage),this.trigger("flip",this,this.currentPage))}loadFromImages(t){const e=new m(this.block,this,this.setting).getCanvas();this.render=new p(e,this.setting),this.flip=new c(this.render,this),this.render.start(),this.pages=new o(this.render,t),this.pages.load(),this.pages.show(this.setting.startPage),this.currentPage=this.setting.startPage,this.trigger("flip",this,this.currentPage)}loadFromHTML(){const t=new P(this.block,this,this.setting);this.render=new x(t.getDistElement(),this.setting),this.flip=new c(this.render,this),this.render.start(),this.pages=new g(this.render,t.getDistElement()),this.pages.load(),this.pages.show(this.setting.startPage),this.currentPage=this.setting.startPage,this.trigger("flip",this,this.currentPage)}updateState(t){this.trigger("changeState",this,t)}getPageCount(){return this.pages.getPageCount()}getCurrentPageIndex(){return this.currentPage}getCurrentPage(){return this.pages.getPage(this.currentPage)}getPage(t){return this.pages.getPage(t)}startUserTouch(t){this.mousePosition=t,this.isUserTouch=!0,this.isUserMove=!1}userMove(t){this.isUserTouch?r.GetDestinationFromTwoPoint(this.mousePosition,t)>5&&(this.isUserMove=!0,this.flip.fold(t)):this.flip.showCorner(t)}userStop(t){this.isUserTouch&&(this.isUserTouch=!1,this.isUserMove?this.flip.stopMove():this.flip.flip(t))}checkPage(t){return t>=0&&t<this.pages.getPageCount()}}}]);